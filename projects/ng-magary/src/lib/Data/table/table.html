<div
  class="magary-table-container"
  [class.responsive-layout]="responsiveLayout()"
>
  <!-- Header / Toolbar -->
  @if (title() || globalFilterFields().length > 0) {
    <div class="magary-table-header">
      @if (title()) {
        <div class="table-title">
          {{ title() }}
        </div>
      }
      <div class="table-actions">
        @if (globalFilterFields().length > 0) {
          <div class="search-wrapper">
            <magary-input
              placeholder="Search..."
              prefixIcon="search"
              (valueChange)="onSearch($event)"
              width="250px"
              size="small"
            >
            </magary-input>
          </div>
        }
      </div>
    </div>
  }

  <!-- Table Wrapper -->
  <div
    class="table-scroll-wrapper"
    tabindex="0"
    role="region"
    [attr.aria-label]="title() ? title() + ' data region' : 'Table data region'"
  >
    <table class="magary-table">
      @if (columns().length > 0) {
        <colgroup>
          @for (col of columns(); track col.field) {
            <col [style.width]="col.width || null" />
          }
        </colgroup>
      }
      @if (captionTemplate) {
        <caption>
          <ng-container [ngTemplateOutlet]="captionTemplate"></ng-container>
        </caption>
      }
      <thead>
        @if (headerTemplate) {
          <ng-container [ngTemplateOutlet]="headerTemplate"></ng-container>
        } @else {
          <tr>
            @for (col of columns(); track col.field) {
              <th
                [attr.aria-sort]="col.sortable ? getAriaSort(col.field) : null"
              >
                @if (col.sortable) {
                  <button
                    type="button"
                    class="magary-sort-button"
                    (click)="toggleSort(col.field)"
                    [attr.aria-label]="getSortButtonLabel(col.header, col.field)"
                  >
                    <span>{{ col.header }}</span>
                    <lucide-icon [name]="getSortIcon(col.field)" [size]="14"></lucide-icon>
                  </button>
                } @else {
                  {{ col.header }}
                }
              </th>
            }
          </tr>
        }
      </thead>
      <tbody>
        <!-- Data Rows -->
        @if (bodyTemplate) {
          @for (row of paginatedData(); track trackByRow($index, row)) {
            <ng-container
              [ngTemplateOutlet]="bodyTemplate"
              [ngTemplateOutletContext]="{
                $implicit: row,
                columns: columns(),
              }"
            ></ng-container>
          }
        } @else {
          @for (row of paginatedData(); track trackByRow($index, row)) {
            <tr class="table-row">
              @for (col of columns(); track col.field) {
                <td [attr.data-label]="col.header">
                  <span
                    class="table-cell-value"
                    [class.cell-avatar]="col.type === 'avatar'"
                    [class.cell-badge]="col.type === 'badge'"
                  >
                    <!-- Content Switch -->
                    @switch (col.type) {
                      @case ("avatar") {
                        <magary-avatar
                          [image]="getAvatarImage(row, col.field)"
                          [label]="!getAvatarImage(row, col.field) ? getAvatarLabel(row) : ''"
                          shape="circle"
                          size="normal"
                        >
                        </magary-avatar>
                      }
                      @case ("badge") {
                        <span class="magary-badge" [ngClass]="getBadgeClass(row, col.field)">
                          {{ resolveFieldDataAsString(row, col.field) }}
                        </span>
                      }
                      @case ("currency") {
                        {{ resolveFieldDataAsNumber(row, col.field) | currency }}
                      }
                      @case ("date") {
                        {{ resolveFieldDataAsDate(row, col.field) | date }}
                      }
                      @default {
                        {{ resolveFieldDataAsString(row, col.field) }}
                      }
                    }
                  </span>
                </td>
              }
            </tr>
          }
        }

        <!-- Skeleton Rows -->
        @if (loading()) {
          @for (i of skeletonRows(); track i) {
            <tr class="table-row skeleton-row">
              @for (col of columns(); track col.field) {
                <td>
                  <magary-skeleton
                    width="100%"
                    height="1.5rem"
                  ></magary-skeleton>
                </td>
              }
            </tr>
          }
        }

        <!-- Empty State -->
        @if (paginatedData().length === 0 && !loading()) {
          <tr class="empty-row">
            <td [attr.colspan]="columns().length">
              <div class="empty-state">
                <lucide-icon name="inbox" [size]="48"></lucide-icon>
                <p>No records found</p>
              </div>
            </td>
          </tr>
        }
      </tbody>
    </table>
  </div>

  <!-- Paginator -->
  @if (paginator()) {
    <div class="magary-table-paginator-wrapper">
      <magary-paginator
        [first]="first()"
        [rows]="currentRows()"
        [totalRecords]="totalRecords()"
        [rowsPerPageOptions]="rowsPerPageOptions()"
        (onPageChange)="onPaginatorChange($event)"
      >
      </magary-paginator>
    </div>
  }
</div>
