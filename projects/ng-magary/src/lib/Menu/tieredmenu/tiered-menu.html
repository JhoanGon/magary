<div
  #container
  [ngClass]="containerClass()"
  [class.magary-tieredmenu-popup]="popup()"
  [class.magary-tieredmenu-visible]="visible()"
  [style]="style()"
  (click)="onContainerClick($event)"
  (mouseleave)="onMouseLeave()"
>
  <ul class="magary-tieredmenu-root-list">
    <ng-template ngFor let-item [ngForOf]="processedModel()">
      <li
        appTieredMenuItem
        [item]="item"
        [parent]="this"
        class="magary-menuitem"
        [ngClass]="{
          'magary-menuitem-active': item.expanded,
          'magary-menu-separator': item.separator,
        }"
      >
        @if (item.separator) {
          <!-- Separator rendered via CSS class but we can add accessible role -->
        } @else {
          <div class="magary-menuitem-content">
            <a
              class="magary-menuitem-link"
              [href]="item.url || '#'"
              [attr.target]="item.target"
              (click)="onItemClick($event, item)"
              [class.magary-disabled]="item.disabled"
            >
              @if (item.icon) {
                <lucide-icon
                  [name]="item.icon"
                  class="magary-menuitem-icon"
                  [size]="16"
                ></lucide-icon>
              }
              <span class="magary-menuitem-text">{{ item.label }}</span>
              @if (item.items && item.items.length > 0) {
                <lucide-icon
                  name="chevron-right"
                  class="magary-submenu-icon"
                  [size]="14"
                ></lucide-icon>
              }
            </a>
          </div>

          <!-- Recursive Submenu -->
          @if (item.items && item.items.length > 0) {
            <ul class="magary-submenu">
              <ng-template ngFor let-child [ngForOf]="item.items">
                <li
                  appTieredMenuItem
                  [item]="child"
                  [parent]="this"
                  class="magary-menuitem"
                  [ngClass]="{
                    'magary-menuitem-active': child.expanded,
                    'magary-menu-separator': child.separator,
                  }"
                >
                  @if (child.separator) {
                  } @else {
                    <div class="magary-menuitem-content">
                      <a
                        class="magary-menuitem-link"
                        [href]="child.url || '#'"
                        [attr.target]="child.target"
                        (click)="onItemClick($event, child)"
                        [class.magary-disabled]="child.disabled"
                      >
                        @if (child.icon) {
                          <lucide-icon
                            [name]="child.icon"
                            class="magary-menuitem-icon"
                            [size]="16"
                          ></lucide-icon>
                        }
                        <span class="magary-menuitem-text">{{
                          child.label
                        }}</span>
                        @if (child.items && child.items.length > 0) {
                          <lucide-icon
                            name="chevron-right"
                            class="magary-submenu-icon"
                            [size]="14"
                          ></lucide-icon>
                        }
                      </a>
                    </div>
                    @if (child.items && child.items.length > 0) {
                      <!-- Handled recursively by directive or template? 
                                  Template recursion is cleaner for N levels. 
                                  Let's use a template reference. -->
                      <ng-container
                        *ngTemplateOutlet="
                          submenuTemplate;
                          context: { $implicit: child.items }
                        "
                      ></ng-container>
                    }
                  }
                </li>
              </ng-template>
            </ul>
          }
        }
      </li>
    </ng-template>
  </ul>
</div>

<!-- Reusable Recursive Template -->
<ng-template #submenuTemplate let-items>
  <ul class="magary-submenu">
    <ng-template ngFor let-child [ngForOf]="items">
      <li
        appTieredMenuItem
        [item]="child"
        [parent]="this"
        class="magary-menuitem"
        [ngClass]="{
          'magary-menuitem-active': child.expanded,
          'magary-menu-separator': child.separator,
        }"
      >
        @if (!child.separator) {
          <div class="magary-menuitem-content">
            <a
              class="magary-menuitem-link"
              [href]="child.url || '#'"
              (click)="onItemClick($event, child)"
            >
              @if (child.icon) {
                <lucide-icon
                  [name]="child.icon"
                  class="magary-menuitem-icon"
                  [size]="16"
                ></lucide-icon>
              }
              <span class="magary-menuitem-text">{{ child.label }}</span>
              @if (child.items && child.items.length > 0) {
                <lucide-icon
                  name="chevron-right"
                  class="magary-submenu-icon"
                  [size]="14"
                ></lucide-icon>
              }
            </a>
          </div>
          @if (child.items && child.items.length > 0) {
            <ng-container
              *ngTemplateOutlet="
                submenuTemplate;
                context: { $implicit: child.items }
              "
            ></ng-container>
          }
        }
      </li>
    </ng-template>
  </ul>
</ng-template>
