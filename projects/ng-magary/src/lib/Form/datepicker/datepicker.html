<div
  class="magary-datepicker"
  [class.disabled]="isDisabled()"
  (click)="onContainerClick($event)"
>
  <div class="input-group">
    <input
      [id]="triggerId"
      type="text"
      [placeholder]="placeholder() || 'dd/mm/yyyy'"
      [value]="formattedValue()"
      [disabled]="isDisabled()"
      (focus)="open()"
      (input)="onInput($event)"
      (keydown)="onTriggerKeydown($event)"
      class="datepicker-input"
      role="combobox"
      aria-autocomplete="none"
      aria-haspopup="dialog"
      [attr.aria-expanded]="isOpen()"
      [attr.aria-controls]="isOpen() ? panelId : null"
    />
    <button
      type="button"
      class="datepicker-trigger"
      [disabled]="isDisabled()"
      (click)="toggle()"
      (keydown)="onTriggerKeydown($event)"
      [attr.aria-label]="isOpen() ? 'Close calendar' : 'Open calendar'"
      [attr.aria-controls]="isOpen() ? panelId : null"
      [attr.aria-expanded]="isOpen()"
      tabindex="-1"
    >
      <lucide-icon name="calendar" [size]="18"></lucide-icon>
    </button>
  </div>

  @if (isOpen()) {
    <div
      class="datepicker-panel fade-in"
      [id]="panelId"
      role="dialog"
      aria-modal="false"
      [attr.aria-labelledby]="panelLabelId"
      (keydown)="onPanelKeydown($event)"
    >
      <div class="calendar-header">
        <button
          type="button"
          class="nav-btn"
          [attr.aria-label]="'Previous ' + currentView()"
          (click)="prev()"
        >
          <lucide-icon name="chevron-left" [size]="16"></lucide-icon>
        </button>
        <button
          type="button"
          class="view-switch-btn"
          [id]="panelLabelId"
          aria-label="Switch calendar view"
          (click)="switchView()"
        >
          @if (currentView() === "day") {
            {{ currentMonthName() }} {{ currentYear() }}
          } @else if (currentView() === "month") {
            {{ currentYear() }}
          } @else {
            {{ years()[0] }} - {{ years()[10] }}
          }
        </button>
        <button
          type="button"
          class="nav-btn"
          [attr.aria-label]="'Next ' + currentView()"
          (click)="next()"
        >
          <lucide-icon name="chevron-right" [size]="16"></lucide-icon>
        </button>
      </div>

      <!-- Day View -->
      @if (currentView() === "day") {
        <div
          class="calendar-grid"
          role="grid"
          aria-label="Calendar days"
          [attr.aria-activedescendant]="activeDayId()"
        >
          @for (day of weekDays; track day) {
            <div class="weekday" role="columnheader">{{ day }}</div>
          }

          @for (day of calendarDays(); track $index) {
            @if (day) {
              <button
                type="button"
                class="day"
                [class.today]="isToday(day)"
                [class.selected]="isSelected(day)"
                [class.active]="isActive(day)"
                [class.disabled]="isDisabledDate(day)"
                [class.range-start]="isRangeStart(day)"
                [class.range-end]="isRangeEnd(day)"
                [class.in-range]="isInRange(day)"
                [disabled]="isDisabledDate(day)"
                [id]="getDayId(day)"
                [attr.aria-label]="dayAriaLabel(day)"
                [attr.aria-current]="isToday(day) ? 'date' : null"
                [attr.aria-selected]="isSelected(day)"
                role="gridcell"
                (mouseenter)="onDayHover(day)"
                (click)="selectDate(day)"
              >
                {{ day.getDate() }}
              </button>
            } @else {
              <span class="day empty" aria-hidden="true"></span>
            }
          }
        </div>
      }

      <!-- Month View -->
      @if (currentView() === "month") {
        <div
          class="month-grid"
          role="listbox"
          aria-label="Select month"
          [attr.aria-activedescendant]="activeMonthId()"
        >
          @for (month of monthNames; track month; let i = $index) {
            <button
              type="button"
              class="month-item"
              [class.current]="i === viewDate().getMonth()"
              [class.active]="isActiveMonth(i)"
              [id]="getMonthId(i)"
              role="option"
              [attr.aria-selected]="isActiveMonth(i)"
              (mouseenter)="onMonthHover(i)"
              (click)="selectMonth(i)"
            >
              {{ month.substring(0, 3) }}
            </button>
          }
        </div>
      }

      <!-- Year View -->
      @if (currentView() === "year") {
        <div
          class="year-grid"
          role="listbox"
          aria-label="Select year"
          [attr.aria-activedescendant]="activeYearId()"
        >
          @for (year of years(); track year) {
            <button
              type="button"
              class="year-item"
              [class.current]="year === currentYear()"
              [class.active]="isActiveYear(year)"
              [id]="getYearId(year)"
              role="option"
              [attr.aria-selected]="isActiveYear(year)"
              (mouseenter)="onYearHover(year)"
              (click)="selectYear(year)"
            >
              {{ year }}
            </button>
          }
        </div>
      }
    </div>
  }
</div>
